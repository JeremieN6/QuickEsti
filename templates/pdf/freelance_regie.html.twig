{% extends 'pdf/base.html.twig' %}

{% block title %}{{ title }} - {{ project.type }}{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="header">
        <div class="header-logo">QUICKESTI</div>
        <h1>R√©capitulatif d'Estimation</h1>
        <div class="subtitle">Export Estimation - {{ project.type }}</div>
        <div class="date">{{ generatedAt|date('d/m/Y H:i') }}</div>
    </div>

    <!-- Informations projet -->
    {% if formData and formData.basics %}
    <div class="section">
        <h2 class="section-title" data-icon="1">Informations Projet</h2>
        <div class="grid">
            <div class="card">
                <div class="card-title">Type de Projet</div>
                <p>{{ formData.basics.projectType|default('Application web') }}</p>
            </div>
            
            <div class="card">
                <div class="card-title">Description</div>
                <p>{{ formData.basics.description|default('Mission de d√©veloppement') }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- R√©sum√© du projet -->
    <div class="section">
        <h2 class="section-title" data-icon="2">R√©sum√© Technique</h2>
        <div class="grid">
            <div class="card">
                <div class="card-title">Type de Projet</div>
                <p>{{ project.type }}</p>
            </div>
            
            <div class="card">
                <div class="card-title">Technologies</div>
                <p>{{ project.technologies|default('Non sp√©cifi√©es') }}</p>
            </div>
        </div>
        
        {% if project.description %}
        <div class="card grid-full">
            <div class="card-title">Sp√©cifications Techniques</div>
            <p>{{ project.description }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Param√®tres commerciaux -->
    <div class="section compact-section">
        <h2 class="section-title" data-icon="3">Param√®tres Commerciaux</h2>
        <div class="grid">
            <div class="card">
                <div class="card-title">Mode de Facturation</div>
                <p><span class="badge badge-info">Freelance r√©gie</span></p>
                <p class="text-sm mt-2">Pay√© au temps pass√© (TJM √ó jours)</p>
            </div>
            
            <div class="card">
                <div class="card-title">Disponibilit√©</div>
                <p>{{ (constraints and constraints.isFullTime) ? 'Temps plein' : 'Temps partiel' }}</p>
            </div>
            
            {% if constraints and constraints.securityMargin %}
            <div class="card">
                <div class="card-title">Marge de S√©curit√©</div>
                <p>{{ constraints.securityMargin }}%</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Fonctionnalit√©s -->
    {% if features|length > 0 %}
    <div class="section compact-section">
        <h2 class="section-title" data-icon="4">Fonctionnalit√©s Incluses</h2>
        <ul class="list">
            {% for feature in features %}
                <li>{{ feature }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Devis commercial -->
    <div class="section">
        <h2 class="section-title" data-icon="5">Proposition</h2>
        
        <div class="grid">
            <div class="card">
                <div class="card-title">Dur√©e Estim√©e</div>
                <div class="metric-value">{{ estimation.totalDays }} jours</div>
                <p class="text-sm">{{ (estimation.totalDays / 5)|round(1) }} semaines de travail</p>
            </div>
            
            <div class="card">
                <div class="card-title">Co√ªt Total</div>
                <div class="metric-value">{{ estimation.totalCost|number_format(0, ',', ' ') }}‚Ç¨</div>
                <p class="text-sm">Hors taxes</p>
            </div>

            <div class="card">
                <div class="card-title">Niveau de Confiance</div>
                    <span>{{ indicators.confidence.label }}</span>
                <p class="text-xs" style="color: #64748b; margin-top: 5px;">{{ indicators.confidence.description }}</p>
            </div>
        </div>

        {% if breakdown|length > 0 %}
        <table class="breakdown-table">
            <thead>
                <tr>
                    <th>Phase</th>
                    <th>Description</th>
                    <th>Dur√©e</th>
                    <th>Co√ªt HT</th>
                </tr>
            </thead>
            <tbody>
                {% for phase, details in breakdown %}
                <tr>
                    <td class="font-bold">{{ phase }}</td>
                    <td>{{ details.description|default('Phase de ' ~ phase) }}</td>
                    <td class="text-center">{{ details.days }} jour{{ details.days > 1 ? 's' : '' }}</td>
                    <td class="text-right font-bold">{{ details.cost|number_format(0, ',', ' ') }}‚Ç¨</td>
                </tr>
                {% endfor %}
            </tbody>
            <tbody>
                <tr class="total-row">
                    <td colspan="2" class="font-bold">SOUS-TOTAL HT</td>
                    <td class="text-center font-bold">{{ estimation.totalDays }} jours</td>
                    <td class="text-right font-bold">{{ estimation.totalCost|number_format(0, ',', ' ') }}‚Ç¨</td>
                </tr>
                <tr>
                    <td colspan="3" class="font-bold">TVA (20%)</td>
                    <td class="text-right font-bold">{{ (estimation.totalCost * 0.2)|number_format(0, ',', ' ') }}‚Ç¨</td>
                </tr>
                <tr class="total-row">
                    <td colspan="3" class="font-bold">TOTAL TTC</td>
                    <td class="text-right font-bold">{{ (estimation.totalCost * 1.2)|number_format(0, ',', ' ') }}‚Ç¨</td>
                </tr>
            </tbody>
        </table>
        {% endif %}
    </div>

    <!-- M√©triques de Performance -->
    {% if estimation.breakdown %}
    <div class="section">
        <h2 class="section-title" data-icon="6">M√©triques de Performance</h2>

        <div class="grid">
            <div class="card">
                <div class="card-title">TJM Effectif</div>
                <div class="metric-value">{{ (estimation.totalCost / estimation.totalDays)|number_format(0, ',', ' ') }}‚Ç¨/jour</div>
                <p class="text-sm">Tarif journalier moyen</p>
            </div>

            <div class="card">
                <div class="card-title">Dur√©e Mission</div>
                <div class="metric-value">{{ (estimation.totalDays / 5)|number_format(1) }} sem</div>
                <p class="text-sm">{{ estimation.totalDays }} jours de mission</p>
            </div>

            <div class="card">
                <div class="card-title">Charge Mensuelle</div>
                <div class="metric-value">{{ (estimation.totalDays / (estimation.totalDays / 22))|number_format(0) }} j/mois</div>
                <p class="text-sm">Rythme de travail moyen</p>
            </div>

            <div class="card">
                <div class="card-title">CA Pr√©visionnel</div>
                <div class="metric-value">{{ estimation.totalCost|number_format(0, ',', ' ') }}‚Ç¨</div>
                <p class="text-sm">Chiffre d'affaires total</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Justification TJM R√©gie -->
    {% if estimation.freelanceAnalysis and estimation.freelanceAnalysis.type == 'tjm_justification' %}
    <div class="section">
        <div class="highlight highlight-info">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: #1e40af; display: flex; align-items: center;">
                <span style="margin-right: 8px;">üìà</span>
                {{ estimation.freelanceAnalysis.title }}
            </h3>
            <p style="margin-bottom: 20px; color: #1d4ed8; font-size: 14px;">{{ estimation.freelanceAnalysis.summary }}</p>

            <!-- √âtiquettes color√©es -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                {% for key, detail in estimation.freelanceAnalysis.details %}
                <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px;">
                    <div style="font-size: 10px; font-weight: bold; color: #2563eb; text-transform: uppercase; margin-bottom: 5px;">
                        {% if key == 'complexity' %}COMPLEXIT√â TECHNIQUE
                        {% elseif key == 'technologies' %}TECHNOLOGIES
                        {% elseif key == 'experience' %}EXP√âRIENCE REQUISE
                        {% elseif key == 'market' %}MARCH√â TJM
                        {% else %}{{ key|upper }}{% endif %}
                    </div>
                    <div style="font-size: 13px; color: #1e40af; font-weight: 500;">{{ detail }}</div>
                </div>
                {% endfor %}
            </div>

            <!-- Conclusion mise en avant -->
            <div style="padding: 15px; background: rgba(255,255,255,0.8); border-left: 4px solid #3b82f6; border-radius: 6px;">
                <div style="font-size: 15px; font-weight: bold; color: #1e40af;">
                    {{ estimation.freelanceAnalysis.conclusion }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Planning Pr√©visionnel -->
    {% if estimation.breakdown %}
    <div class="section">
        <h2 class="section-title" data-icon="7">Planning Pr√©visionnel</h2>

        <!-- Distribution temporelle -->
        <h3 style="font-size: 14px; margin-bottom: 10px; color: #374151;">Distribution Temporelle</h3>
        <table class="chart-table">
            <thead>
                <tr style="background: #f8fafc;">
                    <th style="text-align: left; padding: 8px;">P√©riode</th>
                    <th style="text-align: center; padding: 8px;">Semaines</th>
                    <th style="text-align: center; padding: 8px;">Jours</th>
                    <th style="text-align: right; padding: 8px;">Charge (%)</th>
                </tr>
            </thead>
            <tbody>
                {% set totalWeeks = (estimation.totalDays / 5)|round %}
                {% set phase1Weeks = (totalWeeks * 0.3)|round %}
                {% set phase2Weeks = (totalWeeks * 0.5)|round %}
                {% set phase3Weeks = totalWeeks - phase1Weeks - phase2Weeks %}
                
                <tr>
                    <td style="padding: 8px;"><strong>Phase 1 - D√©marrage</strong></td>
                    <td style="text-align: center; padding: 8px;">{{ phase1Weeks }}</td>
                    <td style="text-align: center; padding: 8px;">{{ phase1Weeks * 5 }}</td>
                    <td style="text-align: right; padding: 8px;">30%</td>
                </tr>
                <tr>
                    <td style="padding: 8px;"><strong>Phase 2 - D√©veloppement</strong></td>
                    <td style="text-align: center; padding: 8px;">{{ phase2Weeks }}</td>
                    <td style="text-align: center; padding: 8px;">{{ phase2Weeks * 5 }}</td>
                    <td style="text-align: right; padding: 8px;">50%</td>
                </tr>
                <tr>
                    <td style="padding: 8px;"><strong>Phase 3 - Finalisation</strong></td>
                    <td style="text-align: center; padding: 8px;">{{ phase3Weeks }}</td>
                    <td style="text-align: center; padding: 8px;">{{ phase3Weeks * 5 }}</td>
                    <td style="text-align: right; padding: 8px;">20%</td>
                </tr>
            </tbody>
            <tfoot>
                <tr style="background: #f8fafc; font-weight: bold;">
                    <td style="padding: 8px;"><strong>TOTAL</strong></td>
                    <td style="text-align: center; padding: 8px;">{{ totalWeeks }}</td>
                    <td style="text-align: center; padding: 8px;">{{ estimation.totalDays }}</td>
                    <td style="text-align: right; padding: 8px;">100%</td>
                </tr>
            </tfoot>
        </table>

        <!-- Co√ªt total du projet -->
        <h3 style="font-size: 14px; margin: 20px 0 10px 0; color: #374151;">Co√ªt Total du Projet</h3>
        <table class="chart-table">
            <thead>
                <tr style="background: #f8fafc;">
                    <th style="text-align: left; padding: 8px;">Type de T√¢che</th>
                    <th style="text-align: center; padding: 8px;">Jours</th>
                    <th style="text-align: right; padding: 8px;">TJM (‚Ç¨)</th>
                    <th style="text-align: right; padding: 8px;">Montant (‚Ç¨)</th>
                </tr>
            </thead>
            <tbody>
                {% for phase, details in estimation.breakdown %}
                <tr>
                    <td style="padding: 8px;"><strong>{{ phase }}</strong></td>
                    <td style="text-align: center; padding: 8px;">{{ details.days }}</td>
                    <td style="text-align: right; padding: 8px;">{{ (details.cost / details.days)|number_format(0, ',', ' ') }}</td>
                    <td style="text-align: right; padding: 8px;">{{ details.cost|number_format(0, ',', ' ') }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="background: #f8fafc; font-weight: bold;">
                    <td style="padding: 8px;"><strong>TOTAL MISSION</strong></td>
                    <td style="text-align: center; padding: 8px;">{{ estimation.totalDays }}</td>
                    <td style="text-align: right; padding: 8px;">{{ (estimation.totalCost / estimation.totalDays)|number_format(0, ',', ' ') }}</td>
                    <td style="text-align: right; padding: 8px;">{{ estimation.totalCost|number_format(0, ',', ' ') }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
    {% endif %}

    <!-- Conditions g√©n√©rales -->
    <div class="section">
        <h2 class="section-title" data-icon="8">Conditions G√©n√©rales</h2>
        
        <div class="highlight highlight-warning">
            <p><strong>Mode R√©gie :</strong> Ce devis repr√©sente un prix de vente march√© pour le projet d√©crit. Il inclut :</p>
            <ul class="list mt-2">
                <li>D√©veloppement selon sp√©cifications</li>
                <li>Tests et validation</li>
                <li>Documentation technique</li>
                <li>Support pendant la p√©riode de garantie</li>
            </ul>
        </div>
        
        <div class="highlight">
            <p><strong>Conditions particuli√®res :</strong></p>
            <ul class="list">
                <li>Paiement selon √©ch√©ancier convenu</li>
                <li>Propri√©t√© intellectuelle transf√©r√©e √† la livraison</li>
            </ul>
        </div>

        <div class="highlight">
            <p><strong>Validit√© :</strong> Cette estimation est valable 30 jours √† compter de sa date d'√©mission.</p>
            <p><strong>Paiement :</strong> Selon conditions convenues avec le client</p>
        </div>
    </div>

{% endblock %}
